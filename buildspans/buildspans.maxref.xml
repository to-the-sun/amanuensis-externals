<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet devhelp="true" type="text/xsl" href="pb-patcher.xsl"?>
<c74object name="buildspans" module="max" category="Analysis">
	<digest>Assembles spans of notes and offsets for a music transcript</digest>
	<description>
		The `buildspans` object receives individual note and offset timestamps and groups them into spans for each track. A span is a contiguous sequence of bars. The object automatically ends a span based on two conditions:
		1. **Discontinuity:** A span will end if the object receives a timestamp that creates a bar that is not contiguous with the previous bars. This check happens after the deferred rating check.
		2. **Rating-Based End:** A span will also end based on a deferred rating check that occurs when a new bar is started. The object evaluates the previous bar against the span and will end the span before that previous bar if either of these two conditions are met:
		a. Including the previous bar would have decreased the span's overall rating.
		b. The previous bar's own individual rating (its mean score) is higher than the rating the span would have if the bar were included.
		The rating is calculated as the lowest mean score of any bar in the span multiplied by the number of bars.
		A bang to the first inlet will flush (end and output) all currently open spans for all tracks and palettes.
	</description>
	<!--METADATA-->
	<metadatalist>
		<metadata name="author">Jules</metadata>
		<metadata name="tag">Analysis</metadata>
	</metadatalist>
	<!--INLETS-->
	<inletlist>
		<inlet id="1" type="list/bang/clear">
			<digest>Inlet 1: Timestamp-score pair, bang to flush, or clear</digest>
			<description>
				Receives note data as a list of two floats (absolute timestamp and score) or three floats (synthesized timestamp, score, and original absolute timestamp). If three items are received, the first is used for bar calculation and the third is stored in the dictionary.
				If the global offset has not been set yet, the first timestamp received in this inlet will be used to automatically initialize it.
				A bang message triggers a flush of all currently open spans for all tracks and palettes.
				A clear message resets the internal state.
				The set_bar_buffer message sets the buffer to read bar length from.
			</description>
		</inlet>
		<inlet id="2" type="float">
			<digest>Inlet 2: Global offset timestamp</digest>
			<description>Receives a high-precision float representing a global offset in milliseconds. This value is used for new bars and is stored with full precision in the dictionary.</description>
		</inlet>
		<inlet id="3" type="int">
			<digest>Inlet 3: Track number</digest>
			<description>Receives an integer that sets the current track for incoming notes.</description>
		</inlet>
		<inlet id="4" type="symbol">
			<digest>Inlet 4: Palette name</digest>
			<description>Receives a symbol that sets the current palette.</description>
		</inlet>
		<inlet id="5" type="float">
			<digest>Inlet 5: Local Bar Length</digest>
			<description>Sets a local bar length that is checked before the bar buffer. If this value is 0 or not set, the object retrieves the bar length from the bar buffer and caches it here for future use. A value &lt;= 0 received in this inlet resets the local bar length to 0. It is also reset to 0 upon receiving a 'clear' message or after a flush triggered by a 'bang'.</description>
		</inlet>
	</inletlist>
	<!--OUTLETS-->
	<outletlist>
		<outlet id="1" type="list">
			<digest>Outlet 1: Span of bar timestamps</digest>
			<description>Outputs a list of integers representing the bar timestamps of a completed span.</description>
		</outlet>
		<outlet id="2" type="int">
			<digest>Outlet 2: Track number</digest>
			<description>Outputs the track number associated with the completed span.</description>
		</outlet>
		<outlet id="3" type="anything">
			<digest>Outlet 3: Detailed bar data</digest>
			<description>When a span completes, this outlet outputs detailed data for all bars in that span using selectors in the format track::bar::key.</description>
		</outlet>
		<outlet id="4" type="anything">
			<digest>Outlet 4: Logging (Optional)</digest>
			<description>If the log attribute is enabled, this outlet provides status messages.</description>
		</outlet>
	</outletlist>
	<!--ARGUMENTS-->
	<objarglist />
	<!--MESSAGES-->
	<methodlist>
		<method name="list">
			<digest>Process a single note</digest>
			<description>Receives a list containing either [timestamp, score] or [calc_timestamp, score, store_timestamp].</description>
		</method>
		<method name="bang">
			<digest>Flush all spans</digest>
			<description>Immediately ends and outputs all currently open spans for all tracks.</description>
		</method>
		<method name="clear">
			<digest>Reset internal state</digest>
			<description>Clears all working memory, track data, and resets track, offset, and palette to defaults.</description>
		</method>
		<method name="set_bar_buffer">
			<arglist>
				<arg name="buffer-name" type="symbol" optional="0" />
			</arglist>
			<digest>Set the buffer for bar length</digest>
			<description>Sets the buffer~ object to read the bar length from (defaults to "bar").</description>
		</method>
	</methodlist>
	<!--ATTRIBUTES-->
	<attributelist>
		<attribute name="log" get="1" set="1" type="long" size="1">
			<digest>Enable Logging</digest>
			<description>When enabled (1), creates an additional outlet for status information.</description>
			<attributelist>
				<attribute name="style" get="1" set="1" type="symbol" size="1" value="onoff" />
			</attributelist>
		</attribute>
		<attribute name="visualize" get="1" set="1" type="long" size="1">
			<digest>Enable Visualization</digest>
			<description>When enabled (1), the object sends JSON data to the connected visualization script.</description>
			<attributelist>
				<attribute name="style" get="1" set="1" type="symbol" size="1" value="onoff" />
			</attributelist>
		</attribute>
		<attribute name="defer" get="1" set="1" type="long" size="1">
			<digest>Deferred Execution</digest>
			<description>
				When enabled (1), state-changing operations and span building logic are moved to the Main (UI) thread using deferral. This ensures that the heavy computational work involved in managing the transcript dictionary does not interfere with the precision of the Scheduler or audio processing.
			</description>
			<attributelist>
				<attribute name="style" get="1" set="1" type="symbol" size="1" value="onoff" />
			</attributelist>
		</attribute>
	</attributelist>
	<!--SEEALSO-->
	<seealsolist>
		<seealso name="buildspans" />
		<seealso name="crucible" />
		<seealso name="notify" />
		<seealso name="whichoffset" />
		<seealso name="growbuffer~" />
		<seealso name="stemversion" />
		<seealso name="createproject" />
		<seealso name="dict" />
	</seealsolist>
</c74object>
